<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF è£½ä½œå¤§å¸« - 4K é«˜ç•«è³ªç‰ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LocalForage (ç”¨æ–¼å„²å­˜æš«å­˜æª”ï¼Œå› ç‚ºåœ–ç‰‡å¾ˆå¤§éœ€è¦ç”¨IndexedDB) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <!-- gif.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            transform: scale(1.02);
        }
        /* é¸å–®åˆ†çµ„æ¨£å¼ */
        optgroup {
            background-color: #374151;
            color: #9ca3af;
            font-style: normal;
            font-weight: bold;
        }
        option {
            background-color: #1f2937;
            color: #f3f4f6;
            padding: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="border-b border-gray-700 bg-gray-800 p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                GIF è£½ä½œå¤§å¸«
            </h1>
            <div class="text-xs text-gray-400">
                æ”¯æ´é«˜é” 4K è§£æåº¦ â€¢ è‡ªå‹•æš«å­˜
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
        
        <!-- ä¸»è¦æ§åˆ¶å€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- å·¦å´ï¼šè¨­å®šèˆ‡ä¸Šå‚³ -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- ä¸Šå‚³å€ (ä¿®æ­£æ‹–æ›³é‚è¼¯) -->
                <!-- onclick è§¸ç™¼éš±è—çš„ inputï¼Œé¿å… input è¦†è“‹å°è‡´ drop äº‹ä»¶å¤±æ•ˆ -->
                <div id="drop-zone" onclick="document.getElementById('file-input').click()" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-blue-500 hover:bg-gray-700/50 bg-gray-800 relative group">
                    <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                    <div class="pointer-events-none">
                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-3 group-hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-sm font-medium text-gray-300">é»æ“Šä¸Šå‚³ æˆ– æ‹–æ›³åœ–ç‰‡è‡³æ­¤</p>
                        <p class="text-xs text-gray-500 mt-1">æ”¯æ´ JPG, PNG, WebP</p>
                    </div>
                </div>

                <!-- è¨­å®šé¢æ¿ -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-4">
                    <h2 class="text-lg font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        è¼¸å‡ºè¨­å®š
                    </h2>

                    <!-- ç•«è³ªé¸æ“‡ (æ–°å¢è‡ªå®šç¾©) -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">è§£æåº¦ (ç•«è³ª)</label>
                        <select id="resolution" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <option value="original">åŸå§‹å¤§å° (ä¾ç¬¬ä¸€å¼µåœ–)</option>
                            
                            <optgroup label="æ©«å¼ (Landscape 16:9)">
                                <option value="3840x2160">4K Ultra HD (3840x2160)</option>
                                <option value="1920x1080" selected>Full HD (1920x1080)</option>
                                <option value="1280x720">HD (1280x720)</option>
                            </optgroup>

                            <optgroup label="ç›´å¼ (Portrait 9:16)">
                                <option value="2160x3840">4K ç›´å¼ (2160x3840)</option>
                                <option value="1080x1920">Full HD ç›´å¼ (1080x1920)</option>
                                <option value="720x1280">HD ç›´å¼ (720x1280)</option>
                            </optgroup>

                            <optgroup label="å…¶ä»–">
                                <option value="500x500">æ­£æ–¹å½¢ (500x500)</option>
                                <option value="1080x1080">Instagram æ­£æ–¹å½¢ (1080x1080)</option>
                                <option value="custom">âœ¨ è‡ªå®šç¾©å¤§å°</option>
                            </optgroup>
                        </select>

                        <!-- è‡ªå®šç¾©è¼¸å…¥æ¡† -->
                        <div id="custom-resolution-container" class="hidden mt-2 flex items-center gap-2">
                            <div class="relative w-1/2">
                                <input type="number" id="custom-width" placeholder="å¯¬åº¦" class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:border-blue-500" min="1">
                                <span class="absolute right-2 top-2 text-gray-500 text-xs">px</span>
                            </div>
                            <span class="text-gray-400">Ã—</span>
                            <div class="relative w-1/2">
                                <input type="number" id="custom-height" placeholder="é«˜åº¦" class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-3 pr-8 py-2 text-sm focus:outline-none focus:border-blue-500" min="1">
                                <span class="absolute right-2 top-2 text-gray-500 text-xs">px</span>
                            </div>
                        </div>

                        <p id="warn-4k" class="hidden text-xs text-yellow-500 mt-1">âš ï¸ 4K è™•ç†æ™‚é–“è¼ƒé•·ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚</p>
                    </div>

                    <!-- é€Ÿåº¦æ§åˆ¶ -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">æ¯å¹€å»¶é² (æ¯«ç§’)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="delay-range" min="50" max="1000" step="10" value="200" class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="delay-number" value="200" class="w-16 bg-gray-700 border border-gray-600 rounded text-center text-sm py-1">
                        </div>
                        <p class="text-xs text-gray-500 mt-1 text-right">æ•¸å€¼è¶Šå°é€Ÿåº¦è¶Šå¿«</p>
                    </div>

                     <!-- èƒŒæ™¯é¡è‰² -->
                     <div>
                        <label class="block text-xs text-gray-400 mb-1">å¡«å……èƒŒæ™¯è‰² (è‹¥åœ–ç‰‡æ¯”ä¾‹ä¸åŒ)</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="bg-color" value="#000000" class="h-8 w-8 rounded cursor-pointer bg-transparent border-0 p-0">
                            <span class="text-sm text-gray-300">é¸æ“‡èƒŒæ™¯è‰²</span>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="pt-2 flex flex-col gap-3">
                        <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <span class="btn-text">é–‹å§‹è£½ä½œ GIF</span>
                            <div class="loading-spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </button>
                        
                        <div class="flex gap-2">
                             <button id="clear-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-lg transition-colors text-gray-300">
                                æ¸…ç©ºå…¨éƒ¨
                            </button>
                             <button id="save-draft-btn" class="flex-1 bg-green-700 hover:bg-green-600 text-sm py-2 rounded-lg transition-colors text-white hidden">
                                æ‰‹å‹•å„²å­˜
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç‹€æ…‹é¡¯ç¤º -->
                <div id="status-msg" class="text-center text-sm text-gray-400 min-h-[20px]"></div>

            </div>

            <!-- å³å´ï¼šé è¦½èˆ‡çµæœ -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                
                <!-- åœ–ç‰‡åˆ—è¡¨ -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 min-h-[200px]">
                    <h3 class="text-md font-semibold mb-4 text-gray-300 flex justify-between items-center">
                        åœ–ç‰‡é †åº (é»æ“Š X ç§»é™¤)
                        <span id="image-count" class="text-xs bg-gray-700 px-2 py-1 rounded">0 å¼µåœ–ç‰‡</span>
                    </h3>
                    <div id="preview-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                        <!-- åœ–ç‰‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                        <div id="empty-state" class="col-span-full py-10 text-center text-gray-500 border-2 border-dashed border-gray-700 rounded-lg">
                            å°šç„¡åœ–ç‰‡ï¼Œè«‹å¾å·¦å´ä¸Šå‚³
                        </div>
                    </div>
                </div>

                <!-- çµæœé è¦½ -->
                <div id="result-area" class="hidden bg-gray-800 rounded-xl p-6 border border-gray-700 border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.1)]">
                    <h3 class="text-md font-semibold mb-4 text-blue-300">ğŸ‰ GIF è£½ä½œå®Œæˆ</h3>
                    <div class="flex flex-col items-center">
                        <img id="result-gif" src="" alt="Generated GIF" class="max-w-full rounded shadow-lg mb-4 border border-gray-600 max-h-[500px] object-contain">
                        <div class="flex gap-4 w-full max-w-md">
                            <a id="download-btn" href="#" download="my-animation.gif" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-center py-3 rounded-lg font-bold shadow transition-all">
                                ä¸‹è¼‰ GIF
                            </a>
                            <button onclick="document.getElementById('result-area').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">
                                é—œé–‰
                            </button>
                        </div>
                        <p id="file-size" class="mt-2 text-xs text-gray-500"></p>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Progress Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-xl max-w-sm w-full text-center border border-gray-700 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">æ­£åœ¨æ¸²æŸ“ GIF...</h3>
            <div class="w-full bg-gray-700 rounded-full h-4 mb-4 overflow-hidden">
                <div id="progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-200" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-300">0%</p>
            <p class="text-xs text-gray-500 mt-2">é«˜ç•«è³ªæ¸²æŸ“å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
        </div>
    </div>

    <script>
        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        const state = {
            images: [], // å­˜å„²åœ–ç‰‡çš„ Base64 æ•¸æ“š
            settings: {
                width: 1920,
                height: 1080,
                delay: 200,
                useOriginalSize: false,
                bgColor: '#000000'
            }
        };

        // --- DOM å…ƒç´  ---
        const elems = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            previewGrid: document.getElementById('preview-grid'),
            emptyState: document.getElementById('empty-state'),
            generateBtn: document.getElementById('generate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            resultArea: document.getElementById('result-area'),
            resultGif: document.getElementById('result-gif'),
            downloadBtn: document.getElementById('download-btn'),
            imageCount: document.getElementById('image-count'),
            resolution: document.getElementById('resolution'),
            customContainer: document.getElementById('custom-resolution-container'),
            customWidth: document.getElementById('custom-width'),
            customHeight: document.getElementById('custom-height'),
            delayRange: document.getElementById('delay-range'),
            delayNumber: document.getElementById('delay-number'),
            bgColor: document.getElementById('bg-color'),
            progressModal: document.getElementById('progress-modal'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            warn4k: document.getElementById('warn-4k'),
            fileSize: document.getElementById('file-size'),
            statusMsg: document.getElementById('status-msg')
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            localforage.config({ name: 'gifMakerDB', storeName: 'drafts' });
            await loadDraft(); // å˜—è©¦è®€å–æš«å­˜
            updateUI();
        });

        // --- äº‹ä»¶ç›£è½ ---
        
        // æ‹–æ”¾ä¸Šå‚³
        // ç‚ºäº†é¿å…èˆ‡å­å…ƒç´ çš„äº‹ä»¶è¡çªï¼Œç¢ºä¿åœ¨æ‹–æ›³æ™‚é˜»æ­¢é è¨­è¡Œç‚º
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            elems.dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        elems.dropZone.addEventListener('dragover', (e) => {
            elems.dropZone.classList.add('drag-active');
        });

        elems.dropZone.addEventListener('dragleave', (e) => {
            // åªæœ‰ç•¶é›¢é–‹ dropZone æœ¬èº«æ™‚æ‰ç§»é™¤æ¨£å¼ï¼Œé˜²æ­¢æ»‘éå­å…ƒç´ æ™‚é–ƒçˆ
            if (e.relatedTarget === null || !elems.dropZone.contains(e.relatedTarget)) {
                elems.dropZone.classList.remove('drag-active');
            }
        });

        elems.dropZone.addEventListener('drop', (e) => {
            elems.dropZone.classList.remove('drag-active');
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });

        // é»æ“Šä¸Šå‚³ (é€é div onclick è§¸ç™¼ï¼Œé€™è£¡ç›£è½ change)
        elems.fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // è¨­å®šè®Šæ›´
        elems.delayRange.addEventListener('input', (e) => {
            elems.delayNumber.value = e.target.value;
            saveDraft(); // ç°¡æ˜“è‡ªå‹•å„²å­˜è¨­å®š
        });
        elems.delayNumber.addEventListener('change', (e) => {
            elems.delayRange.value = e.target.value;
            saveDraft();
        });
        
        // è§£æåº¦è®Šæ›´ç›£è½
        elems.resolution.addEventListener('change', (e) => {
            const val = e.target.value;
            
            // è™•ç† 4K è­¦å‘Š
            if (val.includes('3840') || val.includes('2160')) {
                elems.warn4k.classList.remove('hidden');
            } else {
                elems.warn4k.classList.add('hidden');
            }

            // è™•ç†è‡ªå®šç¾©è¼¸å…¥æ¡†é¡¯ç¤º
            if (val === 'custom') {
                elems.customContainer.classList.remove('hidden');
            } else {
                elems.customContainer.classList.add('hidden');
            }

            saveDraft();
        });
        
        // è‡ªå®šç¾©è¼¸å…¥æ¡†è®Šæ›´ç›£è½ (å„²å­˜ç”¨)
        elems.customWidth.addEventListener('input', saveDraft);
        elems.customHeight.addEventListener('input', saveDraft);

        elems.clearBtn.addEventListener('click', clearAll);
        elems.generateBtn.addEventListener('click', generateGIF);

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        async function handleFiles(files) {
            if (!files.length) return;

            elems.statusMsg.textContent = 'æ­£åœ¨è™•ç†åœ–ç‰‡...';
            const newImages = [];
            
            for (let i = 0; i < files.length; i++) {
                if (!files[i].type.startsWith('image/')) continue;
                
                try {
                    const base64 = await fileToBase64(files[i]);
                    newImages.push(base64);
                } catch (err) {
                    console.error('è®€å–éŒ¯èª¤:', err);
                }
            }

            // åŠ å…¥ç‹€æ…‹ä¸¦æ›´æ–°
            state.images = [...state.images, ...newImages];
            await saveDraft();
            updateUI();
            elems.statusMsg.textContent = `å·²æ–°å¢ ${newImages.length} å¼µåœ–ç‰‡`;
            
            // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
            setTimeout(() => { elems.statusMsg.textContent = ''; }, 3000);
            
            // é‡ç½® input ä»¥ä¾¿é‡è¤‡ä¸Šå‚³åŒä¸€æª”æ¡ˆ
            elems.fileInput.value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            state.images.splice(index, 1);
            saveDraft();
            updateUI();
        }

        function clearAll() {
            if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åœ–ç‰‡å—ï¼Ÿ')) return;
            state.images = [];
            elems.resultArea.classList.add('hidden');
            localforage.clear();
            updateUI();
        }

        function updateUI() {
            elems.imageCount.textContent = `${state.images.length} å¼µåœ–ç‰‡`;
            elems.previewGrid.innerHTML = '';

            if (state.images.length === 0) {
                elems.previewGrid.appendChild(elems.emptyState);
                elems.emptyState.classList.remove('hidden');
                elems.generateBtn.disabled = true;
                return;
            }

            elems.emptyState.classList.add('hidden');
            elems.generateBtn.disabled = false;

            state.images.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'relative group aspect-square bg-gray-700 rounded-lg overflow-hidden border border-gray-600';
                
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-full h-full object-cover';
                
                const badge = document.createElement('div');
                badge.className = 'absolute top-1 left-1 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded';
                badge.textContent = index + 1;

                const btn = document.createElement('button');
                btn.innerHTML = '&times;';
                btn.className = 'absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
                btn.onclick = () => removeImage(index);

                div.appendChild(img);
                div.appendChild(badge);
                div.appendChild(btn);
                elems.previewGrid.appendChild(div);
            });
        }

        // --- å„²å­˜é‚è¼¯ (IndexedDB) ---
        async function saveDraft() {
            try {
                await localforage.setItem('gif_images', state.images);
                // å„²å­˜è¨­å®š
                const currentSettings = {
                    resolution: elems.resolution.value,
                    delay: elems.delayNumber.value,
                    customWidth: elems.customWidth.value,
                    customHeight: elems.customHeight.value
                };
                await localforage.setItem('gif_settings', currentSettings);
            } catch (err) {
                console.error('å„²å­˜å¤±æ•—:', err);
                elems.statusMsg.textContent = 'å„²å­˜ç©ºé–“ä¸è¶³ï¼Œéƒ¨åˆ†æš«å­˜å¯èƒ½å¤±æ•—';
            }
        }

        async function loadDraft() {
            try {
                const savedImages = await localforage.getItem('gif_images');
                if (savedImages && Array.isArray(savedImages)) {
                    state.images = savedImages;
                }
                const savedSettings = await localforage.getItem('gif_settings');
                if (savedSettings) {
                    // è¼‰å…¥è§£æåº¦è¨­å®š
                    if(savedSettings.resolution) {
                        elems.resolution.value = savedSettings.resolution;
                        
                        // è™•ç†è‡ªå®šç¾©æ¬„ä½é¡¯ç¤º
                        if (savedSettings.resolution === 'custom') {
                            elems.customContainer.classList.remove('hidden');
                            if (savedSettings.customWidth) elems.customWidth.value = savedSettings.customWidth;
                            if (savedSettings.customHeight) elems.customHeight.value = savedSettings.customHeight;
                        }

                        // è™•ç† 4K è­¦å‘Š
                        if(savedSettings.resolution.includes('3840') || savedSettings.resolution.includes('2160')) {
                            elems.warn4k.classList.remove('hidden');
                        }
                    }

                    // è¼‰å…¥å»¶é²è¨­å®š
                    if(savedSettings.delay) {
                        elems.delayNumber.value = savedSettings.delay;
                        elems.delayRange.value = savedSettings.delay;
                    }
                }
            } catch (err) {
                console.error('è®€å–å¤±æ•—:', err);
            }
        }

        // --- GIF ç”Ÿæˆé‚è¼¯ ---

        // è§£æ±º gif.js éœ€è¦å¤–éƒ¨ worker æª”æ¡ˆçš„å•é¡Œï¼šå‹•æ…‹ç²å– worker ä»£ç¢¼ä¸¦å»ºç«‹ Blob
        async function getWorkerBlob() {
             const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
             const content = await response.text();
             const blob = new Blob([content], { type: 'text/javascript' });
             return URL.createObjectURL(blob);
        }

        async function generateGIF() {
            if (state.images.length === 0) return;

            // UI ç‹€æ…‹æ›´æ–°
            elems.generateBtn.disabled = true;
            elems.progressModal.classList.remove('hidden');
            elems.progressBar.style.width = '0%';
            elems.progressText.textContent = '0%';

            try {
                // 1. æ±ºå®šå°ºå¯¸
                let width, height;
                const resValue = elems.resolution.value;
                const useOriginal = resValue === 'original';

                // é åŠ è¼‰ç¬¬ä¸€å¼µåœ–ä¾†æ±ºå®šåŸºæº–å°ºå¯¸
                const firstImg = await loadImage(state.images[0]);
                
                if (useOriginal) {
                    width = firstImg.width;
                    height = firstImg.height;
                } else if (resValue === 'custom') {
                    // è™•ç†è‡ªå®šç¾©å°ºå¯¸
                    width = parseInt(elems.customWidth.value);
                    height = parseInt(elems.customHeight.value);

                    // é©—è­‰è¼¸å…¥
                    if (!width || !height || width <= 0 || height <= 0) {
                        throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„è‡ªå®šç¾©å¯¬åº¦èˆ‡é«˜åº¦ï¼");
                    }
                } else {
                    const parts = resValue.split('x');
                    width = parseInt(parts[0]);
                    height = parseInt(parts[1]);
                }

                // 2. æº–å‚™ Worker URL
                const workerUrl = await getWorkerBlob();

                // 3. åˆå§‹åŒ– GIF å¯¦ä¾‹
                const gif = new GIF({
                    workers: 2,
                    quality: 10, // 1-30, æ•¸å€¼è¶Šä½å“è³ªè¶Šå¥½ä½†è¶Šæ…¢
                    width: width,
                    height: height,
                    workerScript: workerUrl,
                    background: elems.bgColor.value
                });

                // 4. ç›£è½é€²åº¦
                gif.on('progress', (p) => {
                    const percent = Math.round(p * 100);
                    elems.progressBar.style.width = `${percent}%`;
                    elems.progressText.textContent = `æ¸²æŸ“ä¸­... ${percent}%`;
                });

                // 5. ç›£è½å®Œæˆ
                gif.on('finished', (blob) => {
                    const url = URL.createObjectURL(blob);
                    elems.resultGif.src = url;
                    elems.downloadBtn.href = url;
                    elems.resultArea.classList.remove('hidden');
                    
                    // é¡¯ç¤ºæª”æ¡ˆå¤§å°
                    const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
                    elems.fileSize.textContent = `æª”æ¡ˆå¤§å°: ${sizeMB} MB`;

                    // å¾©åŸ UI
                    elems.progressModal.classList.add('hidden');
                    elems.generateBtn.disabled = false;
                    
                    // æ»¾å‹•åˆ°çµæœå€
                    elems.resultArea.scrollIntoView({ behavior: 'smooth' });
                });

                // 6. ç¹ªè£½æ¯ä¸€å¹€
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                const delay = parseInt(elems.delayNumber.value);
                const bgColor = elems.bgColor.value;

                for (let i = 0; i < state.images.length; i++) {
                    const img = await loadImage(state.images[i]);
                    
                    // æ¸…ç©ºç•«å¸ƒä¸¦å¡«è‰²
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // è¨ˆç®—ç¸®æ”¾ä»¥é©æ‡‰ (Contain æ¨¡å¼ - ä¿æŒæ¯”ä¾‹ä¸è£åˆ‡)
                    const scale = Math.min(width / img.width, height / img.height);
                    const x = (width / 2) - (img.width / 2) * scale;
                    const y = (height / 2) - (img.height / 2) * scale;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    
                    gif.addFrame(ctx, {copy: true, delay: delay});
                }

                // 7. é–‹å§‹æ¸²æŸ“
                gif.render();

            } catch (error) {
                console.error(error);
                alert('è£½ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                elems.progressModal.classList.add('hidden');
                elems.generateBtn.disabled = false;
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šè¼‰å…¥åœ–ç‰‡ç‰©ä»¶
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }
    </script>
</body>
</html>